name: Deploy to Lightsail

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Setup Go
        uses: actions/setup-go@v6.2.0
        with:
          go-version: '1.26'

      - name: Build
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: go build -o cloud-between-api .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file
        run: |
          cat > .env <<EOF
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_SCHEMA=${{ secrets.DB_SCHEMA }}
          EOF

      - name: Transfer files
        run: |
          scp -i ~/.ssh/deploy_key \
            cloud-between-api \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}:/home/ubuntu/cloud-between-api/cloud-between-api.new

          scp -i ~/.ssh/deploy_key \
            .env \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}:/home/ubuntu/cloud-between-api/.env

          scp -i ~/.ssh/deploy_key \
            scripts/deploy.sh \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}:/home/ubuntu/cloud-between-api/deploy.sh

      - name: Deploy
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }} \
            "chmod +x /home/ubuntu/cloud-between-api/deploy.sh && /home/ubuntu/cloud-between-api/deploy.sh"
